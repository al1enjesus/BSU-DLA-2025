```markdown
# Лабораторная работа 4: Системные вызовы

## Автор
Луцкий Вадим  
Группа: 9, Подгруппа: 1  
Номер в списке: 15 (программы: gcc, make, as)

## Описание
Исследование системных вызовов в Linux через:
- **LD_PRELOAD** - перехват системных вызовов
- **Benchmark** - измерение производительности системных вызовов

## Структура проекта
```
ЛУЦКИЙВАДИМ/
├── src/
│   ├── syscall_spy.c    # Библиотека для перехвата системных вызовов
│   ├── benchmark.c      # Программа для измерения производительности
│   └── Makefile         # Система сборки
├── logs/                # Папка для логов экспериментов
├── run_experiments.sh   # Основной скрипт тестирования
├── REPORT.MD           # Полный отчёт по лабораторной
└── README.md           # Этот файл
```

## Требования
- **ОС**: Linux или WSL2
- **Компилятор**: gcc
- **Утилиты**: make, perf (опционально)
- **Права**: sudo (для экспериментов с кэшем)

## Быстрый старт

### 1. Клонирование и настройка
```bash
# Переход в рабочую директорию
cd ~/BSU-DLA-2025/lab4/gr9sub1/ЛУЦКИЙВАДИМ

# Проверка структуры файлов
ls -la src/
```

### 2. Компиляция
```bash
cd src
make
```

**Ожидаемый вывод:**
```
✅ Библиотека скомпилирована: libsyscall_spy.so
✅ Бенчмарк скомпилирован: benchmark
```

### 3. Проверка работоспособности
```bash
# Тест библиотеки перехвата
LD_PRELOAD=./libsyscall_spy.so ls /tmp

# Тест бенчмарка
./benchmark
```

## Полное тестирование

### Автоматический запуск всех экспериментов
```bash
# Возвращаемся в корневую папку
cd ..

# Даём права на выполнение (если нужно)
chmod +x run_experiments.sh

# Запуск полного тестирования
./run_experiments.sh
```

**Что делает скрипт:**
- ✅ Компилирует библиотеку и бенчмарк
- ✅ Тестирует LD_PRELOAD на gcc, make, as
- ✅ Запускает бенчмарк системных вызовов
- ✅ Проводит эксперимент с кэшем
- ✅ Сохраняет все логи в папку `logs/`

## Ручное тестирование

### Задание A: LD_PRELOAD перехват
```bash
# Тестирование на программах из группы 3
LD_PRELOAD=./src/libsyscall_spy.so gcc --version
LD_PRELOAD=./src/libsyscall_spy.so make --version
LD_PRELOAD=./src/libsyscall_spy.so as --version

# Тест статической программы
echo '#include <stdio.h>' > test.c
echo 'int main() { printf("test\\n"); return 0; }' >> test.c
gcc -static -o test_static test.c
LD_PRELOAD=./src/libsyscall_spy.so ./test_static
```

### Задание B: Benchmark системных вызовов
```bash
# Основной бенчмарк
./src/benchmark

# Дополнительные измерения
perf stat -e cycles,instructions ./src/benchmark  # если установлен perf
```

## Анализ результатов

### Просмотр логов
После запуска `run_experiments.sh` логи сохраняются в:
```bash
# Посмотреть последнюю папку с логами
ls -lat logs/ | head -5

# Просмотр основных результатов
cat logs/experiment_*/summary.txt

# Просмотр системных вызовов (если перехват сработал)
cat logs/experiment_*/gcc_syscalls.log
cat logs/experiment_*/benchmark.log
```

### Ожидаемые результаты
- **Бенчмарк**: таблица с временами выполнения разных системных вызовов
- **LD_PRELOAD**: логи системных вызовов для тестируемых программ
- **Кэш**: сравнение времени работы с холодным и горячим кэшем

## Устранение неполадок

### Проблема: Компиляция не удаётся
```bash
# Очистка и перекомпиляция
cd src
make clean
make

# Проверка зависимостей
gcc --version
make --version
```

### Проблема: LD_PRELOAD не работает
```bash
# Проверка типа бинарника
file /usr/bin/gcc

# Проверка динамических библиотек
ldd /usr/bin/gcc

# Тест на простой программе
LD_PRELOAD=./src/libsyscall_spy.so cat /etc/hosts
```

### Проблема: Perf не установлен
```bash
# В WSL2 perf может быть недоступен
sudo apt update
sudo apt install linux-tools-generic linux-tools-$(uname -r)
```

## Особенности реализации

### Библиотека перехвата (libsyscall_spy.so)
- Перехватывает: `open`, `openat`, `read`, `write`, `close`
- Декодирует флаги файловых операций
- Избегает рекурсии при записи в stderr
- Использует `dlsym(RTLD_NEXT, ...)` для вызова оригинальных функций

### Бенчмарк (benchmark)
- Измеряет: `dummy()`, `getpid()`, `gettimeofday()`, `open()+close()`
- Использует RDTSC для тактов и `clock_gettime` для наносекунд
- Проводит эксперименты с кэшем страниц

## Известные ограничения

1. **WSL2**: Некоторые функции могут работать иначе чем в нативном Linux
2. **Perf**: Может быть недоступен в WSL2 без дополнительной настройки
3. **Перехват**: Может не работать для некоторых программ из-за особенностей их реализации

## Валидация выполнения

После запуска проверьте:

✅ **Компиляция**: `ls src/libsyscall_spy.so src/benchmark`  
✅ **Логи**: `ls -la logs/experiment_*/`  
✅ **Результаты**: `cat logs/experiment_*/summary.txt`  
✅ **Бенчмарк**: `cat logs/experiment_*/benchmark.log`

## Дополнительные материалы

- Полный отчёт: `REPORT.MD`
- Исходные коды: `src/`
- Логи экспериментов: `logs/`

---
*Лабораторная работа выполнена в октябре 2025 года*
```