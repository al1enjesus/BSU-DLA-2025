# Лабораторная 1 — Bash: анализ логов

## Цель

Проанализировать логи системы для получения информации о наиболее частых событиях, неудачных попытках входа и установленных пакетах.

## Задания

### A) Частотный анализ слов в syslog (TOP‑5)

Для выполнения этой задачи были предприняты следующие **шаги**:

1. `cat /var/log/syslog` — прочитан файл лога и отправлен в конвейер; источник данных для последующей обработки.
2. `tr -cs '[:alnum:]' '\n'` — все символы, не являющиеся буквами или цифрами, заменены на перевод строки, повторяющиеся разделители схлопнуты; результат — одно слово на строку.
3. `tr '[:upper:]' '[:lower:]'` — все буквы преобразованы в нижний регистр, чтобы исключить различия по регистру при подсчёте.
4. `sort` — лексикографически отсортированы строки (слова), чтобы одинаковые строки шли подряд и были готовы к агрегации.
5. `uniq -c` — удалены соседние дубликаты и перед каждой уникальной строкой выведено количество её вхождений.
6. `sort -nr` — отсортировано по числовому значению счётчика в обратном порядке (сначала самые частые).
7. `head -n 5` — показаны первые 5 строк результата — топ-5 самых частых слов в логе.

В результате получился следующий конвейер:

```bash
cat /var/log/syslog \
  | tr -cs '[:alnum:]' '\n' \
  | tr '[:upper:]' '[:lower:]' \
  | sort \
  | uniq -c \
  | sort -nr \
  | head -n 5
```

**Результат:**

```
  200777 rsyslog
  200088 rsyslogd
  151785 error
  150705 com
  150476 https
```

**Тестирование** производилось с помощью запуска команды и сравнении результата с поиском по документу.

**Вывод:** Самыми частыми словами в `/var/log/syslog` являются `rsyslog`, `rsyslogd`, `error`, `com`, `https`. Это указывает на то, что большинство записей в syslog связаны с работой службы rsyslog, а также содержит много сообщений об ошибках и записей, содержащих "com" и "https".

### Б) Неудачные попытки входа (auth.log)

Для выполнения этой задачи были предприняты следующие **шаги**:

1. `cat /var/log/auth.log` — прочитан файл журнала авторизации и передан в конвейер.
2. `grep -iE 'Failed|Invalid'` — отобраны только строки, где встречаются слова `Failed` или `Invalid` (без учёта регистра).
3. `grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}'` — из этих строк извлечены только IP-адреса по регулярному выражению.
4. `sort` — все IP-адреса отсортированы, чтобы одинаковые значения шли подряд.
5. `uniq -c` — подсчитано количество вхождений каждого уникального IP-адреса.
6. `sort -nr` — результат отсортирован по числовому счётчику в обратном порядке (сначала самые частые IP).
7. `head -n 10` — выбраны 10 самых частых IP-адресов.
8. `sed -E 's/([0-9]+\.[0-9]+\.[0-9]+)\.[0-9]+/\1.x/'` — замаскирован последний октет IP (например, `192.168.0.15 → 192.168.0.x`) для анонимизации.

В результате получился следующий конвейер:

```bash
cat /var/log/auth.log \
	| grep -iE 'Failed|Invalid' \
	| grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' \
	| sort \
	| uniq -c \
	| sort -nr \
	| head -n 10 \
	| sed -E 's/([0-9]+\.[0-9]+\.[0-9]+)\.[0-9]+/\1.x/'
```

**Результат:**

Команда не вернула никакого результата.

**Анализ:**

Я проанализировал файл `/var/log/auth.log` и обнаружил, что в нем есть записи о сбоях аутентификации, но они не содержат IP-адресов. Поэтому я попросил ChatGPT написать генератор, который содержится в файле [auth_generator.py](logs/generator/auth_generator.py). В результате генерации я получил файл [auth.test](logs/auth.test), на котором тестировал свой конвейер:

```bash
cat ./auth.test \
	| grep -iE 'Failed|Invalid' \
	| grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' \
	| sort \
	| uniq -c \
	| sort -nr \
	| head -n 10 \
	| sed -E 's/([0-9]+\.[0-9]+\.[0-9]+)\.[0-9]+/\1.x/'
```

**Результат:**

```
  452 185.34.56.x
  425 203.0.113.x
  419 192.168.1.x
  411 198.51.100.x
  396 203.0.113.x
  372 127.0.0.x
  362 10.10.10.x
  350 192.0.2.x
  335 203.0.113.x
  332 192.0.2.x
```

**Тестирование** производилось с помощью запуска команды и сравнении результата с поиском по документу.

**Вывод:** В логе `/var/log/auth.log` нет неудачных попыток входа с указанием IP-адреса. В то же время анализ файла [auth.test](logs/auth.test) показал наличие большого числа неудачных попыток входа с различных IP-адресов. Наибольшее количество попыток исходит от повторяющихся сетевых подсетей, что может свидетельствовать о переборе паролей (brute-force) или автоматизированных атаках. Анонимизация последнего октета IP позволяет выявить активность подсетей без раскрытия конкретных адресов.

### В) Установки пакетов (dpkg.log)

Для выполнения этой задачи были предприняты следующие **шаги**:

1. `grep -oP '\s+install\s+\K\S+' /var/log/dpkg.log` — прочитан файл `/var/log/dpkg.log` и с помощью `grep` (PCRE, опция `-P`) извлечены только имена пакетов, которые идут после слова `install`. Выражение `\s+install\s+\K\S+` находит слово `install` с пробелами вокруг и возвращает (`\K`) следующие непробельные символы — собственно имя пакета.
2. `sort` — отсортированы имена пакетов в лексикографическом порядке, чтобы одинаковые имена шли подряд и их можно было посчитать.
3. `uniq -c` — подсчитано количество вхождений каждого уникального имени пакета (каждая строка вида `<count> <package>`).
4. `sort -nr` — отсортировано по числовому счётчику в обратном порядке (сначала самые часто устанавливаемые пакеты).
5. `head -n 10` — показаны первые 10 строк результата — топ-10 самых часто встречающихся установок.

В результате получился следующий конвейер:

```bash
grep -oP '\s+install\s+\K\S+' /var/log/dpkg.log \
	| sort \
	| uniq -c \
	| sort -nr \
	| head -n 10
```

**Результат:**

```
  1 zstd:amd64
  1 zlib1g-dev:amd64
  1 zlib1g:amd64
  1 zip:amd64
  1 zenity-common:all
  1 zenity:amd64
  1 yelp-xsl:all
  1 yelp:amd64
  1 yaru-theme-sound:all
  1 yaru-theme-icon:all
```

**Тестирование** производилось с помощью запуска команды и сравнении результата с поиском по документу.

**Вывод:** Все пакеты были установлены по одному разу. Это говорит о том, что в последнее время не было массовых установок пакетов.

## Запуск

Все команды можно запускать с помощью Makefile.

## Как использовали AI

AI использовался для обработки папки лабораторной, генерации отчёта и проверки выполнения задания. В качестве модели была выбрала Gemini 2.5 Pro.
