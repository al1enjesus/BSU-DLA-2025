# Задание А. #
## Цель: ##
Создаль процесс, который будет создавать воркеров (дочерних процессов), следить за их стостоянием и настраивает дествия на определенные сигналы.

## Шаги: ##
В папке src лежат файлы с кодом. Файл Makefile говорит, что файлы надо соьрать на языке C и говорит какие именно файлы ему нужно собрать.
Собираем ккомандой ```make```.
После можем ввести в терминале команду ```./supervisor``` и она запустит наш процесс. Все махинации с ним надо делать в другом терминале.

Что делает файл супервизор: подключаем библиотеки, задаем верхнюю границу, задаем сколько всего будет воркеров. Задает состояния командам. Функция ```spawn_worker``` берет процесс, проверяет это родитель или ребенок. Если пид == 0, то это ребенок и он говорит ему идти в файл worker, если файл не может быть открытым или найден, то он ловит ошибку и сообщает нам о ней, если родитель, то мы берем маску процессоров, зануляем ее и назначаем каждому 2му определенный процессор (это делается по биту, поэтому получится что cpu у нас будут 1 и 0). Функция ```sigchld_handler``` родитель отлавливает сигналы ребенка и, если этот сигнал будет завершающим, будет перезапускать процесс, чтоюы измежать зомби. Далее мы назначаем определенные значения сигналам, чтобы отслеживать их и запускаем вечный while, в котором отслеживаем сигналы.
Файл воркер: Сначала задаем значения для сложный и легких режимов. Пишем функцию, которая будет делать имитацию работы, в зависимости от режима. Также мы запускаем while, который считает тик, запускает работу и выводит на экран результат работы.

## Фрагменты выводов: ##
По умолчанию у нас стоит сложный режим. командой ```kill -USR1 /pid/``` сменим режим на легкий.

```[Worker 65034] tick=9358 mode=heavy CPU=1 
[Worker 65033] tick=7896 mode=heavy CPU=0
[Worker 65034] tick=9359 mode=light CPU=1
[Worker 65035] tick=4617 mode=light CPU=0
[Worker 65033] tick=7897 mode=light CPU=0 
```

Командой ```kill -USR2 /pid/``` меняем на сложный режим

```[Worker 65034] tick=9278 mode=light CPU=1
[Worker 65035] tick=4578 mode=light CPU=0
[Worker 65033] tick=7829 mode=heavy CPU=0
[Worker 65034] tick=9279 mode=heavy CPU=1
[Worker 65035] tick=4579 mode=heavy CPU=0
[Worker 65034] tick=9280 mode=heavy CPU=1
```
Узнать ```id pid``` командой ```ps -ef | grep supervisor``` 

Команда ```ill -HUP /pid/``` мы перезапустим всех воркеров

```[Worker 64733] tick=6691 mode=heavy CPU=1
[Worker 64734] tick=4939 mode=heavy CPU=0
[Worker 64733] tick=6692 mode=heavy CPU=1
[Worker 64732] tick=4958 mode=heavy CPU=0
[Supervisor] reload requested
[Worker 64733] tick=6693 mode=heavy CPU=1
[Worker 64734] tick=4940 mode=heavy CPU=0
[Worker 64732] tick=4959 mode=heavy CPU=0
[Worker 64732] exiting gracefully
[Supervisor] started worker 0 (pid=64754)
[Worker 64733] tick=6694 mode=heavy CPU=1
[Worker 64733] exiting gracefully
[Supervisor] started worker 1 (pid=64755)
[Worker 64734] tick=4941 mode=heavy CPU=0
[Worker 64734] exiting gracefully
[Supervisor] started worker 2 (pid=64756)
[Worker 64755] tick=1 mode=heavy CPU=1
[Worker 64754] tick=1 mode=heavy CPU=0
[Worker 64755] tick=2 mode=heavy CPU=1
[Worker 64756] tick=1 mode=heavy CPU=0
```
Команда ```kill -9 /worker/``` убивает одного воркера, но код это отследит и перезапустит его, чтобы не появилось зомби.

```[Worker 64865] tick=13768 mode=heavy CPU=1
[Worker 64864] tick=11488 mode=heavy CPU=0
[Worker 64865] tick=13769 mode=heavy CPU=1
[Supervisor] worker 1 (pid=64865) exited, restarting...
[Worker 64866] tick=6668 mode=heavy CPU=0
[Supervisor] started worker 1 (pid=64948)
[Worker 64864] tick=11489 mode=heavy CPU=0
[Worker 64948] tick=1 mode=heavy CPU=1
[Worker 64864] tick=11490 mode=heavy CPU=0
[Worker 64866] tick=6669 mode=heavy CPU=0
[Worker 64948] tick=2 mode=heavy CPU=1
```
Команда ```kill -TERM /pid/``` остановит всех воркеров и не даст их перезапустить.

```[Worker 64865] tick=13768 mode=heavy CPU=1
[Worker 64864] tick=11488 mode=heavy CPU=0
[Worker 64865] tick=13769 mode=heavy CPU=1
[Supervisor] worker 1 (pid=64865) exited, restarting...
[Worker 64866] tick=6668 mode=heavy CPU=0
[Supervisor] started worker 1 (pid=64948)
[Worker 64864] tick=11489 mode=heavy CPU=0
[Worker 64948] tick=1 mode=heavy CPU=1
[Worker 64864] tick=11490 mode=heavy CPU=0
[Worker 64866] tick=6669 mode=heavy CPU=0
[Worker 64948] tick=2 mode=heavy CPU=1
```
## Выводы: ##
Все сработало как надо, по фрагментам можно все отследить. Все команды, кроме ```kill -9 /pid/``` были сделаны на главном воркере. Но их можно повторить и для детей.

# Задание Б. #
## Цели: ##
Снять метрики, проверить нагрузку. Продемонстрировать как приоритет влияет на показатели.

## Шаги, фрагменты кода и выводы: ##
#### 1. Для кажого ребенка посмотрим id приоритет и command ####
```
anna@anna-IdeaPad-3-15ALC6:~$ ps -o pid,ni,comm -p 65363
    PID  NI COMMAND
  65363  10 worker
anna@anna-IdeaPad-3-15ALC6:~$ ps -o pid,ni,comm -p 65362
    PID  NI COMMAND
  65362   0 worker
anna@anna-IdeaPad-3-15ALC6:~$ ps -o pid,ni,comm -p 65364
    PID  NI COMMAND
  65364  10 worker
```
Заметим, что у нас 2 воркера с приоритетом 10 и один с приоритетом 0.
#### 2. Для каждого ребенка посмотри на каком процессоре он работает ####
```
anna@anna-IdeaPad-3-15ALC6:~$ taskset -pc 65363
pid 65363's current affinity list: 1
anna@anna-IdeaPad-3-15ALC6:~$ taskset -pc 65362
pid 65362's current affinity list: 0
anna@anna-IdeaPad-3-15ALC6:~$ taskset -pc 65364
pid 65364's current affinity list: 0
```
Заметим, что они по мере id чередуют процессор 0 1 0, как мы и сделали в коде
#### 3. Для каждого воркера посмотри характеристики: ####
```
anna@anna-IdeaPad-3-15ALC6:~$ pidstat -u 1 10 -p 65363
Linux 6.14.0-29-generic (anna-IdeaPad-3-15ALC6)   09/22/2025   _x86_64_(8 CPU)

03:39:10 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
03:39:11 PM  1000     65363    9.00   80.00    0.00    0.00   89.00     1  worker
03:39:12 PM  1000     65363    6.00   83.00    0.00    0.00   89.00     1  worker
03:39:13 PM  1000     65363    7.00   83.00    0.00    0.00   90.00     1  worker
03:39:14 PM  1000     65363    7.00   83.00    0.00    0.00   90.00     1  worker
03:39:15 PM  1000     65363    8.00   81.00    0.00    0.00   89.00     1  worker
03:39:16 PM  1000     65363    6.00   83.00    0.00    0.00   89.00     1  worker
03:39:17 PM  1000     65363    7.00   83.00    0.00    0.00   90.00     1  worker
03:39:18 PM  1000     65363    7.00   83.00    0.00    0.00   90.00     1  worker
03:39:19 PM  1000     65363    7.00   82.00    0.00    0.00   89.00     1  worker
03:39:20 PM  1000     65363    7.00   83.00    0.00    0.00   90.00     1  worker
Average:     1000     65363    7.10   82.40    0.00    0.00   89.50     -  worker
anna@anna-IdeaPad-3-15ALC6:~$ pidstat -u 1 10 -p 65362
Linux 6.14.0-29-generic (anna-IdeaPad-3-15ALC6)   09/22/2025   _x86_64_(8 CPU)

03:39:23 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
03:39:24 PM  1000     65362    5.00   70.00    0.00   17.00   75.00     0  worker
03:39:25 PM  1000     65362    6.00   65.00    0.00   20.00   71.00     0  worker
03:39:26 PM  1000     65362    4.00   69.00    0.00   17.00   73.00     0  worker
03:39:27 PM  1000     65362    7.00   67.00    0.00   17.00   74.00     0  worker
03:39:28 PM  1000     65362    6.00   69.00    0.00   17.00   75.00     0  worker
03:39:29 PM  1000     65362    5.00   70.00    0.00   16.00   75.00     0  worker
03:39:30 PM  1000     65362    6.00   69.00    0.00   17.00   75.00     0  worker
03:39:31 PM  1000     65362    6.00   68.00    0.00   16.00   74.00     0  worker
03:39:32 PM  1000     65362    6.00   67.00    0.00   19.00   73.00     0  worker
03:39:33 PM  1000     65362    6.00   69.00    0.00   16.00   75.00     0  worker
Average:     1000     65362    5.70   68.30    0.00   17.20   74.00     -  worker
anna@anna-IdeaPad-3-15ALC6:~$ pidstat -u 1 10 -p 65364
Linux 6.14.0-29-generic (anna-IdeaPad-3-15ALC6)   09/22/2025   _x86_64_(8 CPU)

03:39:36 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
03:39:37 PM  1000     65364    2.00   15.00    0.00   78.00   17.00     0  worker
03:39:38 PM  1000     65364    1.00   16.00    0.00   77.00   17.00     0  worker
03:39:39 PM  1000     65364    2.00   16.00    0.00   78.00   18.00     0  worker
03:39:40 PM  1000     65364    1.00   17.00    0.00   77.00   18.00     0  worker
03:39:41 PM  1000     65364    1.00   17.00    0.00   78.00   18.00     0  worker
03:39:42 PM  1000     65364    2.00   16.00    0.00   77.00   18.00     0  worker
03:39:43 PM  1000     65364    1.00   14.00    0.00   79.00   15.00     0  worker
03:39:44 PM  1000     65364    2.00   15.00    0.00   79.00   17.00     0  worker
03:39:45 PM  1000     65364    2.00   17.00    0.00   76.00   19.00     0  worker
03:39:46 PM  1000     65364    1.00   16.00    0.00   77.00   17.00     0  worker
Average:     1000     65364    1.50   15.90    0.00   77.60   17.40     -  worker
```
Заметим, что 65362 и 65364 на одном cpu, и у 65362 приоритет лучше, поэтому у него процент cpu больше, ждет он меньше и системы поглощает больше
#### 4. Изменим приоритет у 65362 и еще раз посмотрим характеристики: ####
```
anna@anna-IdeaPad-3-15ALC6:~$ renice +10 -p 65362
65362 (process ID) old priority 0, new priority 10
anna@anna-IdeaPad-3-15ALC6:~$ pidstat -u 1 10 -p 65362
Linux 6.14.0-29-generic (anna-IdeaPad-3-15ALC6)   09/22/2025   _x86_64_(8 CPU)

03:49:20 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
03:49:21 PM  1000     65362    5.00   42.00    0.00   44.00   47.00     0  worker
03:49:22 PM  1000     65362    3.00   42.00    0.00   44.00   45.00     0  worker
03:49:23 PM  1000     65362    5.00   42.00    0.00   45.00   47.00     0  worker
03:49:24 PM  1000     65362    4.00   42.00    0.00   44.00   46.00     0  worker
03:49:25 PM  1000     65362    4.00   43.00    0.00   44.00   47.00     0  worker
03:49:26 PM  1000     65362    3.00   43.00    0.00   45.00   46.00     0  worker
03:49:27 PM  1000     65362    4.00   43.00    0.00   44.00   47.00     0  worker
03:49:28 PM  1000     65362    3.00   43.00    0.00   45.00   46.00     0  worker
03:49:29 PM  1000     65362    3.00   42.00    0.00   43.00   45.00     0  worker
03:49:30 PM  1000     65362    5.00   42.00    0.00   44.00   47.00     0  worker
Average:     1000     65362    3.90   42.40    0.00   44.20   46.30     -  worker
anna@anna-IdeaPad-3-15ALC6:~$ pidstat -u 1 10 -p 65364
Linux 6.14.0-29-generic (anna-IdeaPad-3-15ALC6)   09/22/2025   _x86_64_(8 CPU)

03:49:33 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
03:49:34 PM  1000     65364    3.00   43.00    0.00   45.00   46.00     0  worker
03:49:35 PM  1000     65364    3.00   43.00    0.00   44.00   46.00     0  worker
03:49:36 PM  1000     65364    3.00   43.00    0.00   45.00   46.00     0  worker
03:49:37 PM  1000     65364    4.00   43.00    0.00   44.00   47.00     0  worker
03:49:38 PM  1000     65364    3.00   43.00    0.00   44.00   46.00     0  worker
03:49:39 PM  1000     65364    3.00   43.00    0.00   45.00   46.00     0  worker
03:49:40 PM  1000     65364    4.00   43.00    0.00   44.00   47.00     0  worker
03:49:41 PM  1000     65364    3.00   43.00    0.00   44.00   46.00     0  worker
03:49:42 PM  1000     65364    4.00   43.00    0.00   45.00   47.00     0  worker
03:49:43 PM  1000     65364    3.00   42.00    0.00   45.00   45.00     0  worker
Average:     1000     65364    3.30   42.90    0.00   44.50   46.20     -  worker
```
Заметим, что сейчас у них одинаковый приоритет и все показатели у них почти одинаковые, что указывает на то, что они теперь равны друг перед другом.

## Ответы на вопросы: ##
1. Потоки разделяю одно пространство, память, а процессы нет, они полностью изолированы друг от друга. В ps: покажет потоки (колонка LWP). В /proc: у каждого потока своя папка
2. Влияет на вес процесса в планировщике (приоритет выполнения), то есть если niceбудет маленьким, до у него будет больше cpu времни. Пределы от -20 до 19. Исключения: процессы реального времени (RT) всегда приоритетнее
3. Польза: предсказуемость в плане производительности. Вред: неравномерная загрузка CPU, излишняя сложность для большинства задач
4. AS: всё виртуальное пространство. DATA: только куча и статические данные.RSS: физическая память (часто игнорируется из-за сложности реализации)
5. Родитель не сделал wait() после смерти потомка, избежать можно за счет обработчика SIGCHLD с waitpid(WNOHANG)
6. Shutdown: завершить текущие задачи и выход. Reload: новые воркеры запускаются параллельно со старыми, старые завершаются после обработки текущих запросов. Reload безопаснее
7. Он будет считать лимиты контейнера своими лимитами и будет показывать метрики относительно этих лимитов