# Лабораторная 3 — /proc, собственные метрики и диагностика

Курс: Проектирование приложений под Linux (DLA, 4 курс)

Эта лаба продолжает тему процессов и наблюдаемости: читаем метрики процесса напрямую из `/proc`, сравниваем с системными утилитами и практикуем диагностику (`strace`, `perf`).

## Цели
- Уверенно извлекать и интерпретировать метрики процесса из `/proc`.
- Сопоставлять показатели `/proc` с утилитами `ps`, `top`, `pidstat`.
- Освоить базовую диагностику приложений: системные вызовы и аппаратные счётчики.

## Где работать и как сдавать
Работайте в своей папке по схеме (аналогично lab1/lab2):
```
lab3/
  gr<группа>sub<подгруппа>/
    ФАМИЛИЯ_ИМЯ/
      REPORT.MD   # обязательный отчёт: цель → шаги → выводы → ответы → проверка
      README.md   # как запустить и воспроизвести
      src/        # исходники (C/C++/Python/Bash), Makefile по желанию
      run.sh      # (по желанию) сценарий запуска/демо
```
Ветка/PR — как в корневом `README.md`: личная ветка от `main`, работать только в своей папке, открыть PR в `main`.

## Обзор заданий

### C) /proc и собственная утилита pstat (обязательно)
Напишите утилиту `pstat <pid>`, которая:
- Читает `/proc/<pid>/stat`, `/proc/<pid>/status`, `/proc/<pid>/io`, `/proc/<pid>/smaps_rollup` (если есть).
- Выводит краткую сводку: `PPid`, `Threads`, `State`, `utime/stime`, `voluntary_ctxt_switches`, `nonvoluntary_ctxt_switches`, `VmRSS`, `RssAnon`, `RssFile`, `read_bytes`, `write_bytes`.
- Умеет форматировать числа (МиБ/КиБ) и считает `RSS MiB` и «CPU time sec = (utime+stime)/HZ».

Сравните показания с `ps`, `pidstat`, `top` в отчёте.

### E*) Диагностика и профилирование (со звёздочкой)
- `strace -f -c -p <pid>`: топ системных вызовов процесса (или вашего воркера из lab2) в тяжёлом/лёгком режимах.
- `perf stat -p <pid> sleep 5`: базовые аппаратные счётчики (cycles, instructions, branches).
- (Опционально) `perf top`/flamegraph на локальной машине для демонстрации «горячих мест».

## Что конкретно нужно сделать
- Код (в `src/`):
  - Утилита `pstat <pid>`: сводка по `/proc` (см. раздел C).
  - `Makefile` или чёткие команды сборки в `README.md` у студента; при желании `run.sh`.
- Эксперименты (в `REPORT.MD` с командами и выводами):
  - Сопоставьте поля `pstat` с аналогами в `ps`/`top`/`pidstat` и прокомментируйте расхождения.
  - Покажите форматирование чисел и вычисления (`RSS MiB`, CPU time sec).
  - (Для E*) приведите сводные таблицы `strace -c` и результаты `perf stat` с краткими выводами.
- Отчёт: цель → шаги/команды → фрагменты выводов → ответы на вопросы → выводы → как воспроизводить и на какой ОС.

## Артефакты и структура сдачи
- Исходники утилиты `pstat` (`src/`), `Makefile` или инструкции сборки.
- Скрипты/команды воспроизведения экспериментов (`ps`, `pidstat`, `top`, `strace`, `perf`).
- `REPORT.MD` с:
  - краткой теорией/обоснованием шагов,
  - командами и фрагментами вывода,
  - ответами на вопросы (ниже),
  - выводами (что влияет на что и почему),
  - описанием ограничений окружения (WSL2/виртуалка/без root).

## Вопросы для отчёта
1. Где в `/proc/<pid>/stat` и `/proc/<pid>/status` отражаются время в ядре/в юзере и состояние процесса?
2. Как получить `RSS` и чем отличаются `RssAnon` и `RssFile`? Почему они важны?
3. Как оценить IO‑активность по `/proc/<pid>/io` и чем она отличается от «ожидания IO» в `top/pidstat`?
4. Что означает делитель `HZ` и как корректно посчитать `CPU time sec = (utime+stime)/HZ`?
5. Почему возможны рассинхронизации между `/proc` и выводом `ps/top`? Когда это критично?
6. (Для E*) Что показывает `strace -c` и как интерпретировать `perf stat`?

## Критерии зачёта
- Утилита `pstat` корректно читает файлы `/proc` и выводит требуемые поля.
- Числа форматируются, вычисления (RSS MiB, CPU time sec) верны и прокомментированы.
- Показано сопоставление с `ps`/`top`/`pidstat`, сделаны обоснованные выводы.
- `REPORT.MD` структурирован: цель → шаги → данные → ответы → выводы → воспроизводимость.
- Со звёздочкой (E*): приведены диагностические срезы `strace -c` и `perf stat` с кратким анализом.

Примечания для кроссплатформенности:
- На WSL2 часть файлов `/proc` и `perf` может быть недоступна — задокументируйте ограничения и покажите альтернативы.
- На macOS `/proc` нет — эту часть делайте в Linux/WSL2/VM; в отчёте опишите окружение.
