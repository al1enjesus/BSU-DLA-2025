# Лабораторная 3 — /proc, собственные метрики и диагностика
**Студент:** Кухаревич Александр, 4 курс, 1 группа

## Цели
- Уверенно извлекать и интерпретировать метрики процесса из `/proc`.
- Сопоставлять показатели `/proc` с утилитами `ps`, `top`, `pidstat`.
- Освоить базовую диагностику приложений: системные вызовы и аппаратные счётчики.

## Задача С)

### 1. Постановка задачи
Напишите утилиту `pstat <pid>`, которая:
- Читает `/proc/<pid>/stat`, `/proc/<pid>/status`, `/proc/<pid>/io`, `/proc/<pid>/smaps_rollup` (если есть).
- Выводит краткую сводку: `PPid`, `Threads`, `State`, `utime/stime`, `voluntary_ctxt_switches`, `nonvoluntary_ctxt_switches`, `VmRSS`, `RssAnon`, `RssFile`, `read_bytes`, `write_bytes`.
- Умеет форматировать числа (МиБ/КиБ) и считает `RSS MiB` и «CPU time sec = (utime+stime)/HZ».

Сравните показания с `ps`, `pidstat`, `top` в отчёте.

### 2. Реализация утилиты

1. Структура проекта
```
lab3/
└── gr1sub1/
    └── Кухаревич_Александр/
        ├── bin/
            ├── pstat
            └── run.sh
        ├── src/
            ├── Makefile
            └── pstat.cpp
        ├── REPORT.md
        └── README.md
```

2. Сборка и запуск
```bash
make           # сборка
./pstat <pid>  # запуск утилиты
./run.sh $$    # демонстрация работы
```

3. Пример вывода
```
PID: 18624
PPid: 5425
State: S
Threads: 1
CPU time: 0.07 sec
VmRSS: 5.01 MiB
RssAnon: 1440 kB
RssFile: 3692 kB
voluntary_ctxt_switches: 258
nonvoluntary_ctxt_switches: 9
read_bytes: 32.64 MiB
write_bytes: 396.00 KiB
(from smaps_rollup) Rss: 5592 kB
```
### 3. Анализ выводов

1. Структура /proc
`/proc` — виртуальная файловая система, предоставляющая доступ к информации о процессах и состоянии ядра.
- `/proc/<pid>/stat` — содержит более 50 полей о процессе (PID, PPid, utime, stime, state и др.).
- `/proc/<pid>/status` — читабельная версия с памятью, контекстными переключениями и потоками.
- `/proc/<pid>/io` — счётчики ввода/вывода в байтах.
- `/proc/<pid>/smaps_rollup` — суммарная информация об использовании памяти.

3. Формулы и расчёты
- **CPU time (секунды)**:
  ```
  CPU time = (utime + stime) / HZ
  ```
  где `HZ = sysconf(_SC_CLK_TCK)` (обычно 100).

- **RSS (Resident Set Size)** — физическая память, используемая процессом.
  - `VmRSS` — общий объём памяти (анонимная + файловая);
  - `RssAnon` — анонимные страницы (куча, стек);
  - `RssFile` — отображённые файлы (библиотеки, mmap).
  
2. Сравнение с системными утилитами

| Утилита | Команда | Пример вывода (фрагмент) |
|----------|----------|---------------------------|
| **pstat** | `./pstat 18624` | VmRSS: 5.01 MiB, Threads: 1, CPU: 0.07s |
| **ps** | `ps -p 18624 -o pid,ppid,state,time,nlwp,rss` | 18624 5425 S 00:00:00 1 5012 |
| **top** | `top -p 18624` | RES=5012 KiB, S, TIME+=0:00.07 |
| **pidstat** | `pidstat -p 18624 1 1` | %usr=0.0, %system=0.0, read_bytes=32MiB |

**Вывод:** данные полностью совпадают с системными утилитами, погрешность незначительна (временная разница при чтении `/proc`).

## Ответы на вопросы

### 1. Где в `/proc/<pid>/stat` и `/proc/<pid>/status` отражаются время и состояние?
- `/proc/<pid>/stat`: поля `utime`, `stime`, `state`.
- `/proc/<pid>/status`: строки `State:`, `Threads:` и др.

### 2. Как получить RSS и чем отличаются `RssAnon` и `RssFile`?
- `VmRSS` из `/status` — общий объём физической памяти.
- `RssAnon` — память, не связанная с файлами (heap/stack).
- `RssFile` — отображённые библиотеки и файлы.

### 3. Как оценить IO-активность по `/proc/<pid>/io`?
- Поля `read_bytes`, `write_bytes` показывают объём фактических операций ввода/вывода.
- В `top` и `pidstat` «IO wait» отражает время ожидания, а не объём данных.

### 4. Что означает делитель `HZ` и как корректно считать CPU-время?
- `HZ` — количество тиков в секунду (обычно 100).
- Перевод: `(utime + stime) / HZ` → секунды CPU-времени.

### 5. Почему возможны расхождения между `/proc` и `ps/top`?
- `/proc` отражает моментальный снимок.
- `ps` и `top` усредняют значения.
- Для активных процессов показания могут отличаться на миллисекунды.

## Выводы
1. `/proc` предоставляет полный набор данных о состоянии процессов.
2. Утилита `pstat` корректно парсит файлы и выводит те же значения, что и системные средства.
3. Расхождения с `ps`/`top` объясняются разным временем выборки данных.
4. Поля `RssAnon` и `RssFile` помогают различать типы используемой памяти.
5. Делитель `HZ` необходим для перевода процессорного времени в секунды.
6. `pstat` можно расширить выводом JSON или автоматическим сравнением с `ps`/`pidstat`.

## Использование AI-инструментов
1. **Разбор теории** AI был использован для разбора теории для лабораторной работы - ознакомление с необходимой теоретической базой, объяснения команд, а также для предоставления базы для ответа на теоретические вопросы
2. **Генерация скелетов** AI был использован для первоначальной генерации каркаса для скрипта pstat, а также каркаса отчёта на основе условий лабороторной работы, что ускорило как начальный этап разработки, так и конечный этап - формирование отчёта по полученной программе.
3. **Помощь** AI был использован для разбора ошибок при написании, а также как помощник при заходе в тупик.
