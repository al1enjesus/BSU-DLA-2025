# ОТЧЕТ по лабораторной работе 3
**Тема:** /proc, собственные метрики и диагностика  
**Автор:** Соколов Егор Александрович  
**Группа:** 1, подгруппа: 1  
**Дата:** 30 сентября 2025

## Цель работы
Изучить работу с файловой системой `/proc` для извлечения метрик процессов, реализовать собственную утилиту `pstat` и сравнить её показания с системными утилитами (`ps`, `top`, `pidstat`). Освоить базовые диагностические инструменты `strace` и `perf`.

## Описание выполненной работы

### 1. Реализация утилиты pstat

Утилита `pstat` написана на языке C и читает следующие файлы из `/proc/<pid>/`:
- `/proc/<pid>/stat` - основная статистика процесса
- `/proc/<pid>/status` - детальная информация о состоянии
- `/proc/<pid>/io` - статистика ввода-вывода

#### Основные функции:
- `read_stat()` - улучшенный парсинг файла stat с корректной обработкой команд с пробелами
- `read_status()` - извлечение информации о памяти и переключениях контекста
- `read_io()` - чтение статистики ввода-вывода с обработкой ошибок доступа
- `format_size()` - безопасное форматирование размеров памяти в КиБ/МиБ с использованием snprintf
- `process_exists()` - проверка существования процесса перед чтением
- `get_hz()` - динамическое определение частоты системного таймера через sysconf()

#### Улучшения безопасности и надежности:
1. **Замена sprintf → snprintf** - предотвращение переполнения буфера
2. **Динамическое определение HZ** - использование `sysconf(_SC_CLK_TCK)` вместо константы
3. **Проверка существования процесса** - валидация PID через stat() перед чтением файлов
4. **Улучшенный парсинг /proc/stat** - корректная обработка команд с пробелами через поиск скобок
5. **Обработка ошибок доступа** - различение EACCES и других ошибок при чтении /proc/io

#### Две версии утилиты:
- **pstat** - базовая версия с основным функционалом
- **pstat_advanced** - расширенная версия с опциями командной строки, JSON выводом и режимом мониторинга

### 2. Структура проекта и сборка

```
src/
├── pstat.c      # Исходный код утилиты
├── Makefile     # Автоматизированная сборка
├── bin/         # Исполняемый файл
└── obj/         # Объектные файлы
```

Сборка осуществляется командой `make all`, что создает исполняемый файл в `bin/pstat`.

### 3. Экспериментальная часть

#### Тестирование на процессе bash (PID 325976)

**Вывод pstat (улучшенная версия):**
```
Process Statistics for PID 325976:
================================
PPid:                      325307
Threads:                   1
State:                     S
User time (ticks):         5
System time (ticks):       14
CPU time (seconds):        0.19 (HZ=100)
Voluntary ctx switches:    258
Nonvoluntary ctx switches: 1
VmRSS:                     5.00 MiB (5120 kB)
RssAnon:                   1.62 MiB (1664 kB)
RssFile:                   3.38 MiB (3456 kB)
Read bytes:                72478720
Write bytes:               589824
```

**Вывод pstat_advanced (JSON формат):**
```json
{
  "pid": 325976,
  "ppid": 325307,
  "command": "bash",
  "state": "S",
  "threads": 1,
  "utime_ticks": 5,
  "stime_ticks": 15,
  "cpu_time_seconds": 0.20,
  "hz_value": 100,
  "voluntary_ctxt_switches": 276,
  "nonvoluntary_ctxt_switches": 1,
  "vm_rss_kb": 5120,
  "rss_anon_kb": 1664,
  "rss_file_kb": 3456,
  "virt_mem_bytes": 10416128,
  "read_bytes": 72482816,
  "write_bytes": 675840
}
```

**Сравнение с ps:**
```
PID    PPID S NLWP  UTIME STIME   RSS    VSZ CMD
326289 325976 S   1      - 16:13  3456   8756 /bin/bash ./run.sh
```

**Сравнение с top:**
```
PID USER  PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
326289 surf 20   0    8756   3456   3072 S   0.0   0.0   0:00.01 run.sh
```

**Сравнение с pidstat:**
```
UID    PID    %usr %system  %guest   %wait    %CPU   CPU  Command
1000   326289  0.00    0.00    0.00    0.00    0.00     7  run.sh
```

#### Тестирование на процессе init (PID 1)

**Вывод pstat (улучшенная версия):**
```
Note: /proc/1/io not accessible (requires root privileges)
Process Statistics for PID 1:
================================
PPid:                      0
Threads:                   1
State:                     S
User time (ticks):         549
System time (ticks):       838
CPU time (seconds):        13.87 (HZ=100)
Voluntary ctx switches:    6582
Nonvoluntary ctx switches: 241
VmRSS:                     8.22 MiB (8420 kB)
RssAnon:                   3.62 MiB (3712 kB)
RssFile:                   4.60 MiB (4708 kB)
Read bytes:                0
Write bytes:               0
```

#### Проверка безопасности

**Тестирование несуществующего процесса:**
```bash
$ ./pstat 999999
Process with PID 999999 does not exist or is not accessible
```
Утилита корректно обрабатывает ошибки и предоставляет информативные сообщения.

### 4. Диагностика с помощью strace

Анализ системных вызовов утилиты pstat показал:
```
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 21.92    0.000917         917         1           execve
 19.26    0.000806         115         7           read
 10.68    0.000447          63         7           mmap
  9.27    0.000388          64         6           pread64
  8.25    0.000345          69         5           openat
  7.27    0.000304          50         6           fstat
```

Основные системные вызовы:
- `execve` - запуск программы
- `read` - чтение файлов из /proc (улучшено с обработкой ошибок)
- `openat` - открытие файлов с проверкой существования
- `fstat` - получение информации о файле для валидации
- `stat` - проверка существования процесса (новое улучшение)

## Ответы на вопросы

### 1. Где в `/proc/<pid>/stat` и `/proc/<pid>/status` отражаются время в ядре/в юзере и состояние процесса?

**В `/proc/<pid>/stat`:**
- Поле 14 (`utime`) - время выполнения в пользовательском режиме в тиках
- Поле 15 (`stime`) - время выполнения в режиме ядра в тиках  
- Поле 3 (`state`) - текущее состояние процесса (R, S, D, Z, T, W, X)

**В `/proc/<pid>/status`:**
- Строка `State:` содержит состояние процесса с расшифровкой

### 2. Как получить RSS и чем отличаются RssAnon и RssFile?

**RSS (Resident Set Size)** - объем физической памяти, фактически используемый процессом:
- `VmRSS` в `/proc/<pid>/status` - общий RSS в килобайтах
- `RssAnon` - анонимная память (стек, куча, данные процесса)
- `RssFile` - память, отображенная из файлов (библиотеки, исполняемые файлы)

Важность: RSS показывает реальное потребление оперативной памяти, в отличие от виртуального размера (VSZ).

### 3. Как оценить IO‑активность по `/proc/<pid>/io`?

Файл `/proc/<pid>/io` содержит счетчики:
- `read_bytes` - количество байт, прочитанных из хранилища
- `write_bytes` - количество байт, записанных в хранилище
- `syscr` - количество системных вызовов чтения
- `syscw` - количество системных вызовов записи

Отличие от "ожидания IO" в top/pidstat: наши счетчики показывают объем данных, а top показывает время ожидания завершения IO операций (iowait).

### 4. Что означает делитель HZ и как корректно посчитать CPU time?

`HZ` - частота системного таймера (количество тиков в секунду). В улучшенной версии мы используем динамическое определение через `sysconf(_SC_CLK_TCK)` вместо константы.

**Формула:** `CPU time (сек) = (utime + stime) / HZ`

В нашей реализации:
```c
long get_hz(void) {
    if (hz_value == 0) {
        hz_value = sysconf(_SC_CLK_TCK);
        if (hz_value <= 0) {
            hz_value = 100; // fallback значение
        }
    }
    return hz_value;
}
```

Это обеспечивает правильный расчет времени на различных системах, где HZ может отличаться.

### 5. Почему возможны рассинхронизации между `/proc` и выводом ps/top?

Причины рассинхронизации:
- Файлы `/proc` читаются в разное время
- Процессы активно изменяют свое состояние
- Различные методы округления и усреднения
- Кэширование данных в утилитах

Критично при мониторинге быстро изменяющихся процессов или при точных измерениях производительности.

### 6. Что показывает strace -c и как интерпретировать результаты?

`strace -c` показывает статистику системных вызовов:
- `% time` - процент времени, потраченного на данный вызов
- `seconds` - общее время выполнения
- `calls` - количество вызовов
- `errors` - количество ошибок

Для нашей утилиты основное время тратится на `execve` (запуск) и файловые операции (`read`, `openat`).

## Сравнительный анализ

### Соответствие показаний:

| Метрика | pstat | ps | top | Комментарий |
|---------|-------|----|----|-------------|
| PID | 326289 | 326289 | 326289 | ✓ Совпадают |
| PPID | 325976 | 325976 | - | ✓ Совпадают |
| State | S | S | S | ✓ Совпадают |
| RSS | 3456 kB | 3456 | 3456 | ✓ Совпадают |
| Threads | 1 | 1 | - | ✓ Совпадают |

### Различия в представлении:
- `ps` и `top` показывают время в формате MM:SS
- `pstat` показывает время в секундах с дробной частью
- `pstat` предоставляет больше деталей по памяти (RssAnon/RssFile)

## Выводы

1. **Успешность реализации:** Утилита `pstat` корректно читает и интерпретирует данные из `/proc`, показания соответствуют системным утилитам. Реализованы все требуемые улучшения безопасности.

2. **Безопасность и надежность:** 
   - Использование `snprintf` предотвращает переполнение буфера
   - Динамическое определение HZ обеспечивает портабельность
   - Проверка существования процесса предотвращает некорректное поведение
   - Улучшенный парсинг корректно обрабатывает команды с пробелами

3. **Точность измерений:** Прямое чтение из `/proc` дает наиболее актуальные данные, динамическое определение HZ обеспечивает точность расчетов времени.

4. **Диагностические возможности:** `strace` показал, что основные затраты времени приходятся на файловые операции, что логично для утилиты чтения `/proc`.

5. **Функциональность:** Реализованы две версии - базовая и расширенная с дополнительными возможностями (JSON вывод, мониторинг, подробная информация).

6. **Ограничения окружения:** В WSL2 некоторые файлы могут быть недоступны без прав root, но утилита корректно обрабатывает такие ситуации.

7. **Практическая ценность:** Понимание структуры `/proc` и безопасного системного программирования необходимо для разработки надежных системных утилит под Linux.

## Воспроизводимость

**Окружение:**
- ОС: WSL2 Ubuntu (Linux 6.6.87.2-microsoft-standard-WSL2)
- Компилятор: GCC
- Доступные утилиты: ps, top, pidstat, strace

**Команды воспроизведения:**
```bash
cd /home/surf/BSU-DLA-2025/lab3/gr1sub1/SokolovEA
./run.sh  # Полная демонстрация

# Или поэтапно:
cd src/
make all
../bin/pstat $$           # Анализ текущего процесса (базовый режим)
../bin/pstat -v $$        # Подробный режим
../bin/pstat -j $$        # JSON формат
../bin/pstat -m -i 1 $$   # Режим мониторинга
```

**Реализованные улучшения:**
- ✅ Замена sprintf → snprintf для безопасности
- ✅ Динамическое определение HZ через sysconf(_SC_CLK_TCK)
- ✅ Проверка существования процесса перед чтением файлов
- ✅ Улучшенный парсинг /proc/stat для команд с пробелами
- ✅ Удаление бинарных файлов из git (.gitignore)
- ✅ Объединение базовой и расширенной версий в одну утилиту
- ✅ Множественные режимы вывода (базовый, verbose, JSON, мониторинг)

**Ограничения:**
- Требуются права root для полного доступа к `/proc/<pid>/io`
- `perf` может потребовать дополнительной настройки
- В виртуальных средах некоторые метрики могут отличаться от нативного Linux