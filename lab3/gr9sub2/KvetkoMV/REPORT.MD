# Лабораторная работа №3

## Цель исследования

Разработать на языке C консольную утилиту `pstat`, предназначенную для анализа характеристик запущенного процесса с использованием данных из виртуальной файловой системы `/proc`. Проверить корректность получаемых значений, сопоставив их с результатами работы стандартных инструментов Linux — `ps`, `top` и `pidstat`. Освоить структуру `/proc/<pid>` и интерпретацию содержащихся там показателей.

---

## Ход работы

### 1. Разработка утилиты

Основная реализация утилиты размещена в файле `src/pstat.c`.
Она читает информацию из следующих файлов:

* `/proc/<pid>/stat`
* `/proc/<pid>/status`
* `/proc/<pid>/io`

Данные разбираются и выводятся в удобном формате: идентификаторы процессов, состояние, использование CPU, память, контекстные переключения и статистика ввода-вывода.

---

### 2. Сборка и запуск проекта

Управление проектом осуществляется через `Makefile`.
Доступные команды:

```bash
make build           # компиляция проекта
make run pid=<PID>   # запуск утилиты pstat для выбранного процесса
make test DURATION=5 # тестирование и сравнение с системными утилитами
```

---

## Эксперимент

### 3. Проверка на тестовом процессе

Для эксперимента был запущен тестовый процесс, создающий постоянную нагрузку на CPU:

```bash
make test DURATION=5
```

### Пример вывода `pstat`:

```
pstat for PID=243457 (dd)
--------------------------
PPid: 243456
Threads: 1
State: R (running)
CPU (ticks): utime=183, stime=317, total=500 (5.00 sec)
Context switches: voluntary=2, nonvoluntary=42
Memory: VmRSS=1912 kB (1.87 MiB)
IO: read_bytes=73728 B, write_bytes=0 B
```

### Результаты системных утилит

**ps:**

```
PPID THCNT S  UTIME STIME  RSS
243456 1    R  -     00:58 1912
```

**pidstat:**

```
12:58:30 AM  PID  %usr  %system  %CPU  Command
             243457  37.00  63.00  100.00 dd
```

**top:**

```
  PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM TIME+  COMMAND
243457 fancurs+ 20   0  5676 1912 1912 R 100.0 0.0  0:06.24 dd
```

---

## Сопоставление показателей

| Параметр                 | pstat   | ps      | pidstat  | top     | Комментарий         |
| ------------------------ | ------- | ------- | -------- | ------- | ------------------- |
| Родительский PID         | 243456  | 243456  | —        | —       | Совпадает           |
| Количество потоков       | 1       | 1       | —        | —       | Совпадает           |
| Состояние                | R       | R       | R        | R       | Полное совпадение   |
| utime/stime (ticks)      | 183/317 | —/00:58 | —        | —       | Разные форматы      |
| CPU time (сек)           | 5.0     | —       | 100% CPU | 0:06.24 | Совпадает по смыслу |
| VmRSS                    | 1912 kB | 1912 kB | —        | 1912 kB | Совпадает           |
| IO read_bytes            | 72 KiB  | —       | —        | —       | Только из /proc     |
| Контекстные переключения | 2 / 42  | —       | —        | —       | Только в /proc      |

---

## Анализ и интерпретация

* **CPU-время**: утилита использует поля 14 и 15 из `/proc/<pid>/stat` (utime, stime), пересчитывая тики в секунды по частоте `HZ=100`.
* **Память**: `VmRSS` совпадает с данными `ps` и `top`, так как все источники читают `/proc/<pid>/status`.
* **Контекстные переключения** (voluntary и nonvoluntary) — поля, доступные исключительно через `/proc/<pid>/status`.
* **IO-показатели** берутся из `/proc/<pid>/io` и отображают фактические операции ввода-вывода, а не процент ожидания (в отличие от `%wa` в `pidstat`).

---

## Расчёты

* **RSS**: 1912 kB ÷ 1024 = ≈ 1.87 MiB
* **CPU-время**: (183 + 317) / 100 = 5.00 секунд

---

## Ответы на контрольные вопросы

1. **Где отражаются состояние и CPU-время процесса?**

   * `/proc/<pid>/stat`: поля 3, 14, 15.
   * `/proc/<pid>/status`: строка `State:`.

2. **Как определить использование памяти и различие RssAnon/RssFile?**

   * `VmRSS` отражает общий объём физической памяти.
   * `RssAnon` — анонимные страницы (например, выделенные через malloc).
   * `RssFile` — страницы, отображённые на файлы или библиотеки.

3. **Как интерпретировать IO-данные?**

   * `/proc/<pid>/io` содержит суммарные байты операций.
   * Метрики `%wait` в `pidstat/top` показывают долю времени ожидания ввода-вывода, а не объём.

4. **Что такое HZ и зачем он нужен?**

   * `HZ` — количество тиков системного таймера в секунду (обычно 100).
   * Используется для перевода времени из тиков в секунды.

5. **Почему результаты утилит могут не совпадать полностью?**

   * Различное время выборки: файлы `/proc` читаются отдельно, и процесс может изменить состояние между запросами.

---

## Итоговые выводы

* Написанная утилита `pstat` успешно отображает ключевые характеристики процессов и даёт детализированные данные из `/proc`.
* Проверка с `ps`, `top` и `pidstat` показала, что все инструменты используют одинаковые источники, различаясь лишь формой представления.
* Прямое чтение `/proc` позволяет получить показатели, недоступные стандартным командам (например, контекстные переключения или отдельные типы RSS).

---

## Среда выполнения

1. **Операционная система:** Ubuntu 22.04 LTS
2. **Необходимые пакеты:** `gcc`, `make`
3. **Сборка:**

   ```bash
   make build
   ```
4. **Запуск для конкретного PID:**

   ```bash
   make run pid=<PID>
   ```
5. **Автоматическое тестирование:**

   ```bash
   make test DURATION=5
   ```

---

## Использование искусственного интеллекта

ИИ применялся для редактирования и структурирования отчёта, а также для уточнения формулировок и улучшения читаемости текста.
