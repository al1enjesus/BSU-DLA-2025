# Лабораторная работа №3 — /proc, собственные метрики и диагностика

## Цель работы
1. Научиться читать метрики процессов напрямую из файловой системы `/proc`.
2. Реализовать собственную утилиту `pstat` для получения ключевых характеристик процесса.
3. Сопоставить данные `/proc` с выводом системных утилит (`ps`, `top`, `pidstat`).
4. Освоить базовые методы диагностики и профилирования (`strace`, `perf`).

---

## Ход работы

### Шаг 1. Реализация утилиты `pstat`
- Написана утилита на Python (`src/pstat.py`), которая читает следующие файлы:
  - `/proc/<pid>/stat` — состояние, время работы в ядре/пользовательском режиме;
  - `/proc/<pid>/status` — количество потоков, переключения контекста, сводка по RSS (VmRSS, RssAnon, RssFile);
  - `/proc/<pid>/io` — байты чтения/записи;
- Реализовано форматирование памяти в KiB/MiB/GiB.
- Вычисляется `CPU time sec = (utime+stime)/HZ`.

Пример запуска:
```bash
./src/pstat.py 1234
```
Пример вывода:
```
PID: 2952 (firefox)
State: S, PPid: 2341
Threads: 120
CPU time: user=8424.87s system=1565.79s total=9990.66s
Voluntary CS: 824581
Nonvoluntary CS: 16483
VmRSS: 919288 kB (897.74 MiB)
RssAnon: 523724 kB
RssFile: 364404 kB
IO read_bytes: 249449472 B
IO write_bytes: 2713960448 B
```

### Шаг 2. Сравнение с системными утилитами
- Сравнение с ps
```
alex@PCLinux:~$ ps -p 2952 -o pid,ppid,state,etimes,rss
    PID    PPID S ELAPSED   RSS
   2952    2341 S   49408 919248
```
Вывод совпадает по PID, PPid, State, VmRSS.

- Сравнение с top
```
lex@PCLinux:~$ top -p 2952

top - 23:12:32 up 13:48,  1 user,  load average: 1,04, 1,24, 1,14
Задачи:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie
top - 23:12:33 up 13:48,  1 user,  load average: 1,04, 1,24, 1,14
Задачи:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie
top - 23:12:58 up 13:48,  1 user,  load average: 1,02, 1,22, 1,13
Задачи:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie
%Cpu(s):  3,3 us,  1,8 sy,  0,0 ni, 94,9 id,  0,0 wa,  0,0 hi,  0,1 si,  0,0 st 
МиБ Mem :  15909,6 total,   2465,6 free,   5919,2 used,   6847,2 buff/cache     
МиБ Swap:   4769,0 total,   4769,0 free,      0,0 used.   9990,4 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ КОМАНДА                                                            
   2952 alex      20   0   20,2g 918844 395564 S   7,3   5,6 166:51.02 firefox
```
Поля RES в top ≈ VmRSS из pstat, время CPU совпадает с рассчитанным (utime+stime)/HZ.
- Сравнение с pidstat
```
alex@PCLinux:~$ pidstat -p 2952 1 1
Linux 6.14.0-32-generic (PCLinux) 	02.10.2025 	_x86_64_	(12 CPU)

23:15:17      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
23:15:18     1000      2952    2,00    3,00    0,00    0,00    5,00     8  firefox
Среднее:  1000      2952    2,00    3,00    0,00    0,00    5,00     -  firefox
```
%usr и %system соответствуют долям, рассчитанным из utime/stime.
Общая нагрузка CPU (~5%) совпадает с top и с данными скрипта.

## Ответы на вопросы
1. Где в `/proc/<pid>/stat` и `/proc/<pid>/status` отражаются время в ядре/в юзере и состояние процесса? \
В /proc/<pid>/stat: utime (позиция 14), stime (позиция 15), state (позиция 3).
В /proc/<pid>/status: поле State и количество потоков.
2. Как получить `RSS` и чем отличаются `RssAnon` и `RssFile`? Почему они важны? \
RSS = VmRSS в KiB, также видно в /proc/<pid>/status.
RssAnon — анонимные страницы (куча, стек, mmap).
RssFile — отображённые файлы (кэш библиотек, mmap файлов).
Важно для анализа, где именно расходуется память.
3. Как оценить IO‑активность по `/proc/<pid>/io` и чем она отличается от «ожидания IO» в `top/pidstat`? \
/proc/<pid>/io показывает количество прочитанных/записанных байт.
top/pidstat отражают время, которое процесс тратит в ожидании ввода-вывода (%iowait). Это разные метрики.
4. Что означает делитель `HZ` и как корректно посчитать `CPU time sec = (utime+stime)/HZ`? \
HZ — количество тиков системного таймера в секунду (обычно 100 на Linux).
CPU time = (utime + stime) / HZ.
5. Почему возможны рассинхронизации между `/proc` и выводом `ps/top`? Когда это критично? \
Данные в /proc обновляются моментально, утилиты показывают снимок в момент опроса.
Разница возникает при интенсивной нагрузке, когда показатели быстро меняются.
Критично при измерении очень коротких процессов.
6. (Для E*) Что показывает `strace -c` и как интерпретировать `perf stat`? \
strace -c агрегирует вызовы системных функций и время, потраченное на них.
perf stat показывает производительность на уровне CPU: IPC, количество тактов, ветвлений.
Используется для выявления «узких мест» программы.

## Выводы
/proc предоставляет детальную информацию о процессах, включая память, CPU-время, IO.
Реализованная утилита pstat подтверждает соответствие данных системным утилитам (ps, top, pidstat).
Расхождения объясняются моментом замера и частотой обновления утилит.
Метрики RssAnon и RssFile позволяют понять структуру использования памяти.
Диагностика с помощью strace и perf помогает находить «узкие места» — либо в системных вызовах, либо в работе процессора.

## Воспроизводимость
ОС: Ubuntu 24.04

Для запуска:
```bash
chmod +x src/pstat.py
./src/pstat.py <pid>
```